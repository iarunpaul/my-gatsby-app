name: Deploy Enhanced LinkedIn Server to Azure App Service

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-linkedin-server.yml'
  workflow_dispatch:

env:
  # Azure App Service configuration (Free Tier F1)
  RESOURCE_GROUP: "Pollys"
  APP_SERVICE_NAME: "linkedin-career-server"
  APP_SERVICE_PLAN: "asp-linkedin-career-free"
  LOCATION: "west Europe"

  # Node.js configuration
  NODE_VERSION: "18.x"

  # Tier configuration - B1 for reliable uptime, F1 for free (with quota limits)
  SKU: "B1"  # Basic tier - ~$13/month but no daily quota
  TIER: "Basic"
  # SKU: "F1"  # Free tier - $0/month but 60 CPU minutes/day limit
  # TIER: "Free"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ›’ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: server/package.json

    - name: ğŸ“¦ Install dependencies
      run: |
        cd server
        npm ci --production

    - name: ğŸ” Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.SERVER_AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: ğŸ—ï¸ Setup Azure resources (if needed)
      run: |
        echo "ğŸ—ï¸ Ensuring Azure resources exist..."

        # Create resource group if it doesn't exist
        if ! az group show --name ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
          echo "ğŸ“¦ Creating resource group..."
          az group create \
            --name ${{ env.RESOURCE_GROUP }} \
            --location "${{ env.LOCATION }}"
        fi

        # Create App Service Plan if it doesn't exist (Free Tier)
        if ! az appservice plan show --name ${{ env.APP_SERVICE_PLAN }} --resource-group ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
          echo "ğŸ“‹ Creating App Service Plan (Free Tier)..."
          az appservice plan create \
            --name ${{ env.APP_SERVICE_PLAN }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --location "${{ env.LOCATION }}" \
            --sku ${{ env.SKU }} \
            --is-linux
        fi

        # Create Web App if it doesn't exist
        if ! az webapp show --name ${{ env.APP_SERVICE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} >/dev/null 2>&1; then
          echo "ğŸŒ Creating Web App (Node.js)..."
          az webapp create \
            --name ${{ env.APP_SERVICE_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --plan ${{ env.APP_SERVICE_PLAN }} \
            --runtime "NODE:18-lts"
        fi

        echo "âœ… Azure resources ready"

    - name: âš™ï¸ Configure Web App settings
      run: |
        echo "âš™ï¸ Configuring Web App settings..."

        # Set startup command
        az webapp config set \
          --name ${{ env.APP_SERVICE_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --startup-file "node enhanced-linkedin-server.js"

        # Configure application settings (environment variables)
        az webapp config appsettings set \
          --name ${{ env.APP_SERVICE_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --settings \
            WEBSITE_NODE_DEFAULT_VERSION="18-lts" \
            SCM_DO_BUILD_DURING_DEPLOYMENT="true" \
            ENABLE_ORYX_BUILD="true" \
            NODE_ENV="production" \
            PORT="8080" \
            WEBSITES_PORT="8080"

        echo "âœ… Web App settings configured"

    - name: ğŸ” Set environment variables
      run: |
        echo "ğŸ” Setting secure environment variables..."

        # Set secure application settings
        az webapp config appsettings set \
          --name ${{ env.APP_SERVICE_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --settings \
            ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
            LINKEDIN_EMAIL="${{ secrets.LINKEDIN_EMAIL }}" \
            LINKEDIN_PASSWORD="${{ secrets.LINKEDIN_PASSWORD }}" \
            CORS_ORIGIN="${{ secrets.GATSBY_FRONTEND_URL }}" \
            DEBUG="false"

        echo "âœ… Environment variables set"

    - name: ğŸ”„ Restart Web App
      run: |
        echo "ğŸ”„ Restarting Web App after configuration..."
        az webapp restart --name ${{ env.APP_SERVICE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}
        echo "âœ… Web App restarted"

    - name: ğŸš€ Deploy to Azure App Service
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.APP_SERVICE_NAME }}
        resource-group: ${{ env.RESOURCE_GROUP }}
        package: './server'

    - name: â³ Wait for deployment and check status
      run: |
        echo "â³ Waiting for deployment to complete..."

        # Check app status
        APP_STATUS=$(az webapp show --name ${{ env.APP_SERVICE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query state -o tsv)
        echo "ğŸ“Š Current app state: $APP_STATUS"

        # If stopped, start the app
        if [ "$APP_STATUS" = "Stopped" ]; then
          echo "ğŸ”„ App is stopped, starting it..."
          az webapp start --name ${{ env.APP_SERVICE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }}
          sleep 30
        fi

        # Wait for the application to start
        for i in {1..12}; do
          echo "ğŸ“Š Checking deployment status ($i/12)..."

          # Check current status
          CURRENT_STATUS=$(az webapp show --name ${{ env.APP_SERVICE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query state -o tsv)
          echo "Current state: $CURRENT_STATUS"

          # Check if the app is responding
          APP_URL="https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net"
          if curl -f -s "$APP_URL/health" > /dev/null; then
            echo "âœ… Application is responding!"
            break
          fi

          if [ $i -eq 12 ]; then
            echo "âš ï¸ Getting application logs for debugging..."
            az webapp log tail --name ${{ env.APP_SERVICE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --timeout 30 || echo "Could not retrieve logs"
          fi

          sleep 30
        done

    - name: ğŸŒ Get application URL and test
      run: |
        echo "ğŸŒ Getting application URL..."

        APP_URL="https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net"

        echo "âœ… Enhanced LinkedIn Server deployed successfully!"
        echo "ğŸŒ Application URL: $APP_URL"
        echo "ğŸ©º Health Check: $APP_URL/health"
        echo "ğŸ” LinkedIn Jobs API: $APP_URL/api/linkedin/jobs"
        echo "âœï¸ Cover Letter API: $APP_URL/api/career/cover-letter"
        echo "ğŸ’¬ Chat API: $APP_URL/api/career/chat"
        echo ""
        echo "ğŸ¯ Free Tier Configuration:"
        echo "   SKU: ${{ env.SKU }} (Free)"
        echo "   Runtime: Node.js ${{ env.NODE_VERSION }}"
        echo "   Location: ${{ env.LOCATION }}"
        echo ""
        echo "ğŸ’° Estimated Monthly Cost: $0 (Free Tier - 60 CPU minutes/day)"

    - name: ğŸ§ª Test deployment endpoints
      run: |
        echo "ğŸ§ª Testing deployed endpoints..."

        APP_URL="https://${{ env.APP_SERVICE_NAME }}.azurewebsites.net"

        # Test health endpoint
        echo "ğŸ©º Testing health endpoint..."
        if curl -f -s "$APP_URL/health" > /dev/null; then
          echo "âœ… Health check passed"
        else
          echo "âš ï¸ Health check failed (app may be starting up)"
        fi

        # Test LinkedIn jobs endpoint (basic connectivity)
        echo "ğŸ” Testing LinkedIn jobs endpoint..."
        HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$APP_URL/api/linkedin/jobs?keywords=developer&limit=1")
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "âœ… LinkedIn jobs endpoint accessible"
        else
          echo "âš ï¸ LinkedIn jobs endpoint returned status: $HTTP_STATUS"
        fi

        # Test cover letter endpoint (template mode)
        echo "âœï¸ Testing cover letter endpoint..."
        HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
          -X POST "$APP_URL/api/career/cover-letter" \
          -H "Content-Type: application/json" \
          -d '{"message": "cover letter for test position"}')
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "âœ… Cover letter endpoint accessible"
        else
          echo "âš ï¸ Cover letter endpoint returned status: $HTTP_STATUS"
        fi

        echo ""
        echo "ğŸ‰ Deployment completed! Your Enhanced LinkedIn Server is running on Azure App Service Free Tier."
        echo "ğŸ”— Access your server at: $APP_URL"

    - name: ğŸ’° Cost optimization summary
      run: |
        echo "ğŸ’° Azure App Service Free Tier Cost Summary:"
        echo "============================================="
        echo "âœ… App Service: $0/month (Free F1 tier)"
        echo "âœ… Bandwidth: $0/month (within free limits)"
        echo "âœ… Storage: $0/month (1GB included)"
        echo ""
        echo "ğŸ“Š Resource Limits (Free Tier):"
        echo "- CPU Time: 60 minutes/day"
        echo "- Memory: 1GB"
        echo "- Storage: 1GB"
        echo "- Custom domains: Not available"
        echo "- Always On: Not available (app sleeps after 20 min)"
        echo ""
        echo "ğŸ¯ Total Estimated Cost: $0/month"
        echo "ğŸ• App sleep behavior: Sleeps after 20 minutes of inactivity"
        echo "âš¡ Cold start: ~10-30 seconds when waking up"