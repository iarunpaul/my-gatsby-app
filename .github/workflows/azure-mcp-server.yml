# Simplified GitHub Actions Workflow - Avoid Container Apps Environment Issues
name: Deploy LinkedIn MCP Server

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build and Push Docker Image
      run: |
        # Set variables
        ACR_NAME="${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}"
        IMAGE_TAG="${{ github.sha }}"
        IMAGE_NAME="linkedin-mcp-server"
        FULL_IMAGE_NAME="$ACR_NAME.azurecr.io/$IMAGE_NAME"
        
        echo "üê≥ Building image: $FULL_IMAGE_NAME:$IMAGE_TAG"
        
        # Login to ACR using Azure CLI
        az acr login --name $ACR_NAME
        
        # Build and push image with SHA tag
        docker build -t $FULL_IMAGE_NAME:$IMAGE_TAG ./mcp-servers/linkedin-real/
        docker push $FULL_IMAGE_NAME:$IMAGE_TAG
        
        # Also tag and push as latest
        docker tag $FULL_IMAGE_NAME:$IMAGE_TAG $FULL_IMAGE_NAME:latest
        docker push $FULL_IMAGE_NAME:latest
        
        echo "‚úÖ Image pushed: $FULL_IMAGE_NAME:$IMAGE_TAG"
    
    - name: Setup Azure Resources (Minimal)
      run: |
        # Set variables
        RESOURCE_GROUP="Pollys"
        LOCATION="East US"
        ENVIRONMENT_NAME="cae-linkedin-mcp"
        
        echo "üèóÔ∏è Setting up minimal Azure resources..."
        
        # Create resource group if it doesn't exist
        az group create --name $RESOURCE_GROUP --location "$LOCATION" || true
        
        # Check if Container Apps environment exists
        if ! az containerapp env show --name $ENVIRONMENT_NAME --resource-group $RESOURCE_GROUP >/dev/null 2>&1; then
          echo "üÜï Creating Container Apps environment (without Log Analytics)..."
          
          # Create Container Apps environment without Log Analytics workspace
          az containerapp env create \
            --name $ENVIRONMENT_NAME \
            --resource-group $RESOURCE_GROUP \
            --location "$LOCATION" \
            --logs-destination none
        else
          echo "‚úÖ Container Apps environment already exists"
        fi
        
        echo "‚úÖ Azure resources ready"
    
    - name: Deploy Container App with ACR Admin Credentials
      run: |
        # Set variables
        ACR_NAME="${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}"
        ACR_PASSWORD="${{ secrets.AZURE_CONTAINER_REGISTRY_PASSWORD }}"
        IMAGE_TAG="${{ github.sha }}"
        IMAGE_NAME="linkedin-mcp-server"
        FULL_IMAGE_NAME="$ACR_NAME.azurecr.io/$IMAGE_NAME:$IMAGE_TAG"
        RESOURCE_GROUP="Pollys"
        ENVIRONMENT_NAME="cae-linkedin-mcp"
        CONTAINER_APP_NAME="linkedin-mcp-server"
        
        echo "üöÄ Deploying Container App: $CONTAINER_APP_NAME"
        echo "üì¶ Using image: $FULL_IMAGE_NAME"
        echo "üîê Using ACR admin credentials (simpler than managed identity)"
        
        # Check if container app exists
        if az containerapp show --name $CONTAINER_APP_NAME --resource-group $RESOURCE_GROUP >/dev/null 2>&1; then
          echo "üîÑ Updating existing container app..."
          
          # Update existing container app
          az containerapp update \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --image $FULL_IMAGE_NAME \
            --registry-server $ACR_NAME.azurecr.io \
            --registry-username $ACR_NAME \
            --registry-password $ACR_PASSWORD \
            --set-env-vars \
              LINKEDIN_EMAIL="${{ secrets.LINKEDIN_EMAIL }}" \
              LINKEDIN_PASSWORD="${{ secrets.LINKEDIN_PASSWORD }}" \
              ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
              MCP_SERVER_PORT=8001 \
              DEBUG=false \
              GATSBY_LINKEDIN_USERNAME="${{ secrets.GATSBY_LINKEDIN_USERNAME }}"
        else
          echo "üÜï Creating new container app..."
          
          # Create new container app with ACR admin credentials
          az containerapp create \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --environment $ENVIRONMENT_NAME \
            --image $FULL_IMAGE_NAME \
            --registry-server $ACR_NAME.azurecr.io \
            --registry-username $ACR_NAME \
            --registry-password $ACR_PASSWORD \
            --env-vars \
              LINKEDIN_EMAIL="${{ secrets.LINKEDIN_EMAIL }}" \
              LINKEDIN_PASSWORD="${{ secrets.LINKEDIN_PASSWORD }}" \
              ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}" \
              MCP_SERVER_PORT=8001 \
              DEBUG=false \
              GATSBY_LINKEDIN_USERNAME="${{ secrets.GATSBY_LINKEDIN_USERNAME }}" \
            --target-port 8001 \
            --ingress external \
            --min-replicas 0 \
            --max-replicas 3 \
            --cpu 1.0 \
            --memory 2Gi
        fi
        
        echo "‚úÖ Container app deployment completed"
    
    - name: Verify Deployment and Get URL
      run: |
        # Set variables
        RESOURCE_GROUP="Pollys"
        CONTAINER_APP_NAME="linkedin-mcp-server"
        
        echo "üß™ Verifying deployment..."
        
        # Wait for deployment to complete
        echo "‚è≥ Waiting for deployment to stabilize (30 seconds)..."
        sleep 30
        
        # Get the container app URL
        APP_URL=$(az containerapp show \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        
        if [ -n "$APP_URL" ]; then
          echo "‚úÖ Container App deployed successfully!"
          echo "üåê App URL: https://$APP_URL"
          echo "üîç Health Check: https://$APP_URL/health"
          echo "üìä MCP Status: https://$APP_URL/api/mcp/status"
          echo "üìã LinkedIn Summary: https://$APP_URL/api/linkedin/summary"
          
          # Check provisioning state
          PROVISIONING_STATE=$(az containerapp show \
            --name $CONTAINER_APP_NAME \
            --resource-group $RESOURCE_GROUP \
            --query properties.provisioningState \
            --output tsv)
          
          echo "üìã Provisioning State: $PROVISIONING_STATE"
          
          if [ "$PROVISIONING_STATE" = "Succeeded" ]; then
            # Wait for the app to start
            echo "‚è≥ Waiting for app to start (60 seconds)..."
            sleep 60
            
            # Test health endpoint with retries
            echo "ü©∫ Testing health endpoint..."
            for i in {1..5}; do
              if curl -f -s "https://$APP_URL/health" >/dev/null; then
                echo "‚úÖ Health check passed!"
                break
              else
                echo "‚è≥ Attempt $i/5 - waiting 15 seconds..."
                sleep 15
              fi
            done
            
            # Test MCP status
            echo "üîç Testing MCP status..."
            if curl -f -s "https://$APP_URL/api/mcp/status" >/dev/null; then
              echo "‚úÖ MCP status endpoint working!"
            else
              echo "‚ö†Ô∏è MCP status check failed - checking logs..."
              az containerapp logs show --name $CONTAINER_APP_NAME --resource-group $RESOURCE_GROUP --tail 20 || true
            fi
          else
            echo "‚ö†Ô∏è Container App provisioning state: $PROVISIONING_STATE"
            echo "üìã Checking logs for issues..."
            az containerapp logs show --name $CONTAINER_APP_NAME --resource-group $RESOURCE_GROUP --tail 20 || true
          fi
          
        else
          echo "‚ùå Failed to get container app URL"
          exit 1
        fi
    
    - name: Display Summary
      run: |
        # Set variables
        RESOURCE_GROUP="Pollys"
        CONTAINER_APP_NAME="linkedin-mcp-server"
        ACR_NAME="${{ secrets.AZURE_CONTAINER_REGISTRY_USERNAME }}"
        
        echo ""
        echo "üéâ Deployment Summary"
        echo "===================="
        
        # Get app details
        APP_URL=$(az containerapp show \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        
        PROVISIONING_STATE=$(az containerapp show \
          --name $CONTAINER_APP_NAME \
          --resource-group $RESOURCE_GROUP \
          --query properties.provisioningState \
          --output tsv)
        
        echo "üì¶ Container App: $CONTAINER_APP_NAME"
        echo "üè† Resource Group: $RESOURCE_GROUP"
        echo "üê≥ Registry: $ACR_NAME.azurecr.io (using admin credentials)"
        echo "üìä Provisioning State: $PROVISIONING_STATE"
        echo "üåê Public URL: https://$APP_URL"
        echo ""
        echo "üîó API Endpoints:"
        echo "  Health: https://$APP_URL/health"
        echo "  MCP Status: https://$APP_URL/api/mcp/status"
        echo "  LinkedIn Summary: https://$APP_URL/api/linkedin/summary"
        echo ""
        echo "üìã For Gatsby Integration:"
        echo "  Add to your GitHub secrets:"
        echo "  GATSBY_MCP_SERVER_URL=https://$APP_URL"
        echo ""
        if [ "$PROVISIONING_STATE" = "Succeeded" ]; then
          echo "‚úÖ LinkedIn MCP Server deployed successfully!"
        else
          echo "‚ö†Ô∏è Deployment completed but provisioning state is: $PROVISIONING_STATE"
          echo "   Check the Azure portal for more details."
        fi

